<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Make your NQL beautiful</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
  </head>
  <body class="relative min-h-screen w-screen overflow-x-hidden bg-background">
    <main class="container min-h-screen p-4 mx-auto flex flex-col">
      <label class="prose" for="nql-query">Make your NQL beautiful</label>
      <textarea
        data-js-id="nql-query"
        id="nql-query"
        class="w-full p-2 grow border-blue-500"
      ></textarea>
      <button
        data-js-id="format-nql-query"
        class="border border-blue-500 border-t-0 text-blue-500 bg-blue-500 w-full p-2 hover:bg-opacity-20 bg-opacity-10"
      >
        Format
      </button>
    </main>
    <script src="./libs/tree-sitter.js"></script>
    <script type="module">
      const Parser = window.TreeSitter;

      await Parser.init();

      const Nql = await Parser.Language.load("./libs/tree-sitter-nql.wasm");

      const parser = new Parser();

      parser.setLanguage(Nql);

      const nqlQueryInputEl = document.querySelector(
        '[data-js-id="nql-query"]'
      );

      const formatButtonEl = document.querySelector(
        '[data-js-id="format-nql-query"]'
      );

      function formatNqlQuery() {
        const nqlQuery = nqlQueryInputEl.value;

        const tree = parser.parse(nqlQuery);

        const formatNode = (node) =>
          node.children.map((queryChild) => {
            if (queryChild.type === "clause") {
              return (
                "\n\n" +
                queryChild.children[0].text +
                " " +
                queryChild.children[1].children
                  .map((c) => {
                    if (
                      c.type === "and" ||
                      c.type === "by" ||
                      c.type === "field" ||
                      c.type === "or" ||
                      c.type === "sort_order"
                    ) {
                      return "\n  " + c.text;
                    }

                    return c.text;
                  })
                  .join(" ")
              );
            }

            return " " + queryChild.text;
          });

        const formattedNql = tree.rootNode.children?.[0]
          ? formatNode(tree.rootNode.children[0]).join("").trim()
          : nqlQuery;

        nqlQueryInputEl.value = formattedNql;
      }

      formatButtonEl.addEventListener("click", formatNqlQuery);
    </script>
  </body>
</html>
